#!/bin/bash
SWARM=$([ -f /loginvsi/.swarm ] && echo true)

while :       
    do        
        read -ersp " Please enter a new password for admin: " password
        read -ersp " Please confirm the new password: " password2
        if [ $password != $password2 ]; then
            echo "Passwords do not match, try again..."
        else
            echo "changing admin password..."
            echo "admin:$password" | chpasswd
            echo "Stopping portainer.."
            docker rm -f portainer
            rm -rf /opt/portainer
            echo "changing portainer admin password..."
            adminpass=$(docker run --rm httpd:2.4-alpine htpasswd -nbB admin ${password} | cut -d ":" -f 2)
            currentpass=$(cat /usr/bin/loginvsid | grep "ADMINPASS=" | cut -d':' -f2 | cut -d"'" -f2)
            sed -i s,$currentpass,$adminpass, /usr/bin/loginvsid

            if [ $SWARM == "true" ]; then
                docker service rm VSI_identityserver &>/dev/null
                docker service rm appliancemaintenance &>/dev/null
                docker secret rm USER_PASSWORD &>/dev/null
                docker secret rm ADMIN_PASSWORD &>/dev/null
                echo $password | docker secret create ADMIN_PASSWORD - &>/dev/null
                echo $password | docker secret create USER_PASSWORD - &>/dev/null
            fi        
            loginvsid start            
            echo "Password updated successfully"
            break
        fi
    done



	