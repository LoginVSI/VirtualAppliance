#!/bin/bash
services=$(docker service ps -q VSI_appliancemanagement)
for f in $services; do    
    containername=$(docker inspect --format "{{.Status.ContainerStatus.ContainerID}}" "$f")        
done
echo "$(date -Iseconds) ContainerID: $containername" 
while $true 
do
    instruction=$(docker exec "$containername" cat appliancerun | grep -v "No such file" | tr -d '\r')   
      case $instruction in
        regenerateselfsignedcerts)
            echo "$(date -Iseconds) Regenerating self-signed certificates..." 
            /loginvsi/bin/regeneratessl
            echo "done" >appliancerun
            docker cp appliancerun $containername:/app
            rm appliancerun
            sleep 10
            ;;
        importuserdefinedcerts)
            echo "$(date -Iseconds) Starting import of user defined certificates..."  
            echo "$(date -Iseconds) Getting certificates locations from docker container..."  
            crt=$(docker exec "$containername" cat crt | grep -v "No such file" | tr -d '\r') 
            key=$(docker exec "$containername" cat key | grep -v "No such file"| tr -d '\r') 
            password=$(docker exec "$containername" password | grep -v "No such file"| tr -d '\r')             
            if [ -z "$crt" ] || [ -z "$key" ] || [ -z "$password" ]; then
                echo "$(date -Iseconds) Error importing user defined certificates: crt, key or password was empty" 
            else
                echo "$(date -Iseconds) Copying user defined certificates from docker container..."  
                docker cp $containername:$crt /certificates/usercertificate.crt
                docker cp $containername:$key /certificates/usercertificate.key            
                echo "$(date -Iseconds) Importing user defined certificates..." 
                /loginvsi/bin/importuserdefinedcerts /certificates/usercertificate.crt /certificates/usercertificate.key $password
                echo "done" >appliancerun
                docker cp appliancerun $containername:/app
                rm appliancerun
                sleep 10
            fi
            ;;
        *)
            #echo "nothing to do" 
            ;;
    esac
    sleep 10     
done