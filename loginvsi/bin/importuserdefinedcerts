#!/bin/bash
CRT="$1"
KEY="$2"
PASSWORD="$3"

SWARM=$([ -f /loginvsi/.swarm ] && echo true)

# replace the paths in the .env file
sed -i '/SSL_CERTIFICATE_KEY_PATH=/d' /loginvsi/.env
sed -i '/SSL_CERTIFICATE_PATH=/d' /loginvsi/.env   
echo "SSL_CERTIFICATE_KEY_PATH=$KEY" >>/loginvsi/.env
echo "SSL_CERTIFICATE_PATH=$CRT" >>/loginvsi/.env

# Remove CA.crt because we only need it in case of self-signed certificates
[ -f /certificates/CA.crt ] && rm /certificates/CA.crt

if [ $SWARM == "true" ]; then
  # Remove and recreate the secrets
  docker service rm VSI_gateway &>/dev/null
  docker secret rm VSI_SSL_CERTIFICATE_KEY_PASSWORD &>/dev/null
  docker secret rm VSI_VSI_SSL_CERTIFICATE &>/dev/null
  docker secret rm VSI_VSI_SSL_CERTIFICATE_KEY &>/dev/null
  echo $PASSWORD | docker secret create VSI_SSL_CERTIFICATE_KEY_PASSWORD - &>/dev/null
else
  echo $PASSWORD >/certificates/password
  echo "SSL_CERTIFICATE_KEY_PASSWORD_PATH=/certificates/password" >>/loginvsi/.env
fi
#restart portainer and the gateway
docker rm -f portainer &>/dev/null
/usr/bin/loginvsid start